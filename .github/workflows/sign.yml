name: CI

on:
  workflow_dispatch:

jobs:
  sign:
    runs-on: macos-latest
    timeout-minutes: 30

    env:
      SECRET_URL: ${{ secrets.SECRET_URL }}
      SECRET_KEY: ${{ secrets.SECRET_KEY }}

    steps:
      - uses: actions/checkout@v4

      - name: Select newest installed Xcode
        shell: bash
        run: |
          set -euo pipefail
          echo "Installed Xcodes:"
          ls -1 /Applications | grep -E '^Xcode_.*\.app$|^Xcode\.app$' || true

          # Pick highest "Xcode_*.app" by version (sort -V)
          XCODE_APP="$(ls -1 /Applications | grep -E '^Xcode_.*\.app$' | sort -V | tail -n 1)"
          if [ -z "${XCODE_APP:-}" ]; then
            echo "No Xcode_*.app found; falling back to /Applications/Xcode.app"
            sudo xcode-select -s /Applications/Xcode.app
          else
            echo "Using: /Applications/${XCODE_APP}"
            sudo xcode-select -s "/Applications/${XCODE_APP}"
          fi

          echo "Xcode path:"
          xcode-select -p
          xcodebuild -version

      - name: Initialize Xcode (CI safe)
        run: |
          sudo xcodebuild -runFirstLaunch
          sudo xcodebuild -license accept || true

      - name: Prepare Xcode preferences (optional)
        run: |
          mkdir -p ~/Library/Preferences
          if [ -f com.apple.dt.Xcode.plist ]; then
            cp com.apple.dt.Xcode.plist ~/Library/Preferences/
          fi

      - name: Run sign script
        run: |
          chmod +x sign.py
          ./sign.py
