name: CI

on:
  workflow_dispatch:

jobs:
  sign:
    runs-on: macos-latest
    timeout-minutes: 30

    env:
      SECRET_URL: ${{ secrets.SECRET_URL }}
      SECRET_KEY: ${{ secrets.SECRET_KEY }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Show Xcode info
        run: |
          echo "=== Xcode version ==="
          xcodebuild -version

          echo "=== Xcode path ==="
          xcode-select -p

      - name: Run signing script
        run: |
          set -e

          # Ensure Preferences directory exists
          mkdir -p ~/Library/Preferences

          # Copy Xcode preferences if needed by sign.py
          if [ -f "com.apple.dt.Xcode.plist" ]; then
            cp com.apple.dt.Xcode.plist ~/Library/Preferences/
          else
            echo "Warning: com.apple.dt.Xcode.plist not found, continuing..."
          fi

          # Make sure sign.py is executable
          chmod +x sign.py

          # Run signing script
          ./sign.py
