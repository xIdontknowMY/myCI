name: CI

on:
  workflow_dispatch:

jobs:
  sign:
    runs-on: macos-latest
    timeout-minutes: 30

    env:
      SECRET_URL: ${{ secrets.SECRET_URL }}
      SECRET_KEY: ${{ secrets.SECRET_KEY }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Patch util.py to skip xed on CI
        run: |
          python3 - <<'PY'
          from pathlib import Path
          import re

          p = Path("util.py")
          s = p.read_text(encoding="utf-8")

          if "CI detected: skipping `xed`" in s:
            print("util.py already patched")
            raise SystemExit(0)

          if "import os" not in s:
            s = "import os\n" + s

          s2 = re.sub(
            r"def open_xcode\(\):\n(?:[ \t].*\n)+",
            "def open_xcode():\n"
            "    # GitHub Actions / CI runners have no GUI, so xed will fail\n"
            "    if os.getenv('GITHUB_ACTIONS') == 'true' or os.getenv('CI') == 'true':\n"
            "        print(\"CI detected: skipping `xed` (open Xcode)\")\n"
            "        return None\n"
            "    return run_process('xed')\n\n",
            s,
            flags=re.MULTILINE
          )

          p.write_text(s2, encoding="utf-8")
          print("Patched util.py")
          PY

      - name: Run signing script
        run: |
          set -e
          python3 sign.py
